{% extends "base.html" %}

{% block title %}Calendrier - PLANIFY{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='calendar-enhanced.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">
            <i class="fas fa-calendar"></i>
            Calendrier
        </h1>
        
        <!-- Horloge temps réel -->
        <div class="calendar-clock">
            <div class="current-time">
                <i class="fas fa-clock"></i>
                <span id="currentTime">12:00:00</span>
            </div>
            <div class="current-date">
                <span id="currentDate">Mardi 19 novembre 2025</span>
            </div>
        </div>
        
        <div class="calendar-controls">
            <button class="btn btn-outline" onclick="previousMonth()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 id="currentMonth">Novembre 2025</h2>
            <button class="btn btn-outline" onclick="nextMonth()">
                <i class="fas fa-chevron-right"></i>
            </button>
            {% if current_user.role in ['admin', 'professeur'] %}
            <button class="btn btn-primary" onclick="openEventModal()">
                <i class="fas fa-plus"></i>
                Nouvel événement
            </button>
            {% endif %}
        </div>
    </div>
    
    <div class="calendar-container">
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div class="day-name">Lun</div>
                <div class="day-name">Mar</div>
                <div class="day-name">Mer</div>
                <div class="day-name">Jeu</div>
                <div class="day-name">Ven</div>
                <div class="day-name">Sam</div>
                <div class="day-name">Dim</div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal pour nouvel événement (Admin et Professeur uniquement) -->
{% if current_user.role in ['admin', 'professeur'] %}
<div id="eventModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nouvel Événement</h3>
            <button class="modal-close" onclick="closeEventModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="eventForm">
                <div class="form-group">
                    <label for="eventTitle">Titre</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label for="eventDate">Date</label>
                    <input type="date" id="eventDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventStartTime">Heure de début *</label>
                        <input type="time" id="eventStartTime" name="start_time" required>
                        <small class="form-help">Format 24h (ex: 14:30)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventEndTime">Heure de fin *</label>
                        <input type="time" id="eventEndTime" name="end_time" required>
                        <small class="form-help">Doit être après l'heure de début</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="eventType">Type</label>
                    <select id="eventType">
                        <option value="cours">Cours</option>
                        {% if current_user.role in ['eleve', 'professeur'] %}
                        <option value="devoir">Devoir</option>
                        {% endif %}
                        <option value="examen">Examen</option>
                        <option value="reunion">Réunion</option>
                        <option value="personnel">Personnel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="eventDescription">Description</label>
                    <textarea id="eventDescription" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeEventModal()">Annuler</button>
            <button id="deleteEventBtn" class="btn btn-danger" onclick="deleteEvent()" style="display: none;">Supprimer</button>
            <button class="btn btn-primary" onclick="saveEvent()">Enregistrer</button>
        </div>
    </div>
</div>
{% endif %}

<style>
/* Horloge temps réel */
.calendar-clock {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin: 0 2rem;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: var(--border-radius-lg);
    color: white;
    text-align: center;
    box-shadow: var(--shadow);
    min-width: 200px;
}

.current-time {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
}

.current-date {
    font-size: 0.875rem;
    opacity: 0.9;
    font-weight: 500;
}

.calendar-clock i {
    animation: tick 1s infinite;
}

@keyframes tick {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.calendar-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.calendar-controls h2 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--dark);
}

.calendar-container {
    padding: 1.5rem;
    background: white;
    border-radius: var(--border-radius);
}

.calendar-wrapper {
    max-width: 100%;
    margin: 0 auto;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--gray-light);
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-bottom: 1px;
}

.day-name {
    background: var(--primary);
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap: 1px;
    background: var(--gray-light);
    border-radius: var(--border-radius);
    overflow: hidden;
    height: 600px;
}

.calendar-day {
    background: white;
    padding: 0.5rem;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.calendar-day:hover {
    background: var(--light);
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: var(--gray);
}

.calendar-day.today {
    background: var(--primary);
    color: white;
}

.calendar-day.today:hover {
    background: var(--primary);
}

.day-number {
    font-weight: 600;
    margin-bottom: 0.25rem;
    flex-shrink: 0;
    font-size: 0.9rem;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    overflow: hidden;
    max-height: calc(100% - 1.5rem);
}

.event-item {
    background: var(--accent);
    color: white;
    padding: 0.375rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
    line-height: 1.2;
    max-width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
}

.event-time {
    display: block;
    font-weight: 700;
    font-size: 0.65rem;
    opacity: 0.9;
    font-family: 'Courier New', monospace;
}

.event-title {
    display: block;
    font-weight: 600;
    line-height: 1.1;
}

.event-item.now {
    animation: pulse-event 2s infinite;
    border: 2px solid #ffd700;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

@keyframes pulse-event {
    0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
    100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
}

.event-item.cours { background: var(--primary); }
.event-item.devoir { background: var(--secondary); }
.event-item.examen { background: var(--danger); }
.event-item.reunion { background: var(--accent); }
.event-item.personnel { background: var(--gray); }

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--border-radius-lg);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-light);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--gray-light);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
    }
    
    .form-help {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: var(--gray);
        font-style: italic;
    }.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--gray-light);
    border-radius: var(--border-radius);
    font-size: 1rem;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
}

/* Indicateur de dépassement pour les événements */
.events-overflow {
    font-size: 0.6rem;
    color: var(--gray);
    text-align: center;
    padding: 0.1rem;
    font-style: italic;
    border-top: 1px dashed var(--gray-light);
    margin-top: 0.2rem;
    flex-shrink: 0;
}

/* Scroll pour les événements si nécessaire */
.day-events::-webkit-scrollbar {
    width: 2px;
}

.day-events::-webkit-scrollbar-track {
    background: transparent;
}

.day-events::-webkit-scrollbar-thumb {
    background: var(--gray-light);
    border-radius: 1px;
}

@media (max-width: 768px) {
    .calendar-controls {
        flex-direction: column;
        gap: 1rem;
    }
    
    .calendar-clock {
        margin: 0;
        min-width: auto;
        width: 100%;
    }
    
    .current-time {
        font-size: 1.25rem;
    }
    
    .calendar-grid {
        height: 450px;
    }
    
    .calendar-day {
        padding: 0.3rem;
    }
    
    .day-name {
        padding: 0.5rem;
        font-size: 0.75rem;
    }
    
    .day-number {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
    }
    
    .event-item {
        font-size: 0.65rem;
        padding: 0.15rem 0.3rem;
    }
}
</style>

<script>
let currentDate = new Date();
let events = [];
let clockInterval;

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = [
        'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
    ];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // Adjust for Monday start
    
    // Clear calendar
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const prevMonthDay = new Date(year, month, -startingDayOfWeek + i + 1);
        const dayElement = createDayElement(prevMonthDay.getDate(), true);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add days of current month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(year, month, day);
        const isToday = isDateToday(dayDate);
        const dayElement = createDayElement(day, false, isToday, dayDate);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add empty cells for days after month ends
    const totalCells = calendarGrid.children.length;
    const remainingCells = 42 - totalCells; // 6 rows × 7 days
    for (let i = 1; i <= remainingCells; i++) {
        const dayElement = createDayElement(i, true);
        calendarGrid.appendChild(dayElement);
    }
}

function createDayElement(dayNumber, isOtherMonth, isToday = false, date = null) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    if (isOtherMonth) {
        dayElement.classList.add('other-month');
    }
    
    if (isToday) {
        dayElement.classList.add('today');
    }
    
    const dayNumberElement = document.createElement('div');
    dayNumberElement.className = 'day-number';
    dayNumberElement.textContent = dayNumber;
    dayElement.appendChild(dayNumberElement);
    
    if (date && !isOtherMonth) {
        const dayEvents = getDayEvents(date);
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        if (dayEvents.length > 0) {
            // Limiter le nombre d'événements affichés pour éviter la déformation
            const maxVisibleEvents = window.innerWidth > 768 ? 3 : 2;
            const visibleEvents = dayEvents.slice(0, maxVisibleEvents);
            const hiddenCount = dayEvents.length - maxVisibleEvents;
            
            // Trier les événements par heure de début
            visibleEvents.sort((a, b) => {
                if (a.start_time && b.start_time) {
                    return a.start_time.localeCompare(b.start_time);
                }
                return 0;
            });
            
            visibleEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `event-item ${event.type}`;
                eventElement.dataset.eventId = event.id;
                
                // Afficher l'heure si disponible
                if (event.start_time) {
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'event-time';
                    
                    if (event.end_time) {
                        timeSpan.textContent = `${event.start_time.substring(0,5)} - ${event.end_time.substring(0,5)}`;
                    } else {
                        timeSpan.textContent = event.start_time.substring(0,5);
                    }
                    eventElement.appendChild(timeSpan);
                }
                
                // Titre de l'événement
                const titleSpan = document.createElement('span');
                titleSpan.className = 'event-title';
                titleSpan.textContent = event.title;
                eventElement.appendChild(titleSpan);
                
                eventElement.title = `${event.title} - ${event.start_time ? (event.start_time.substring(0,5) + (event.end_time ? ' - ' + event.end_time.substring(0,5) : '')) : 'Toute la journée'}`;
                eventElement.onclick = (e) => {
                    e.stopPropagation();
                    showEventDetails(event);
                };
                eventsContainer.appendChild(eventElement);
            });
            
            // Afficher un indicateur s'il y a plus d'événements
            if (hiddenCount > 0) {
                const overflowIndicator = document.createElement('div');
                overflowIndicator.className = 'events-overflow';
                overflowIndicator.textContent = `+${hiddenCount} autre${hiddenCount > 1 ? 's' : ''}`;
                overflowIndicator.onclick = (e) => {
                    e.stopPropagation();
                    showAllDayEvents(date, dayEvents);
                };
                eventsContainer.appendChild(overflowIndicator);
            }
        }
        
        dayElement.appendChild(eventsContainer);
        
        // Seuls les admins et professeurs peuvent créer des événements 
        const userRole = '{{ current_user.role }}';
        if (userRole === 'admin' || userRole === 'professeur') {
            dayElement.onclick = () => openEventModal(date);
        }
    }
    
    return dayElement;
}

function isDateToday(date) {
    const today = new Date();
    return date.getDate() === today.getDate() &&
           date.getMonth() === today.getMonth() &&
           date.getFullYear() === today.getFullYear();
}

function getDayEvents(date) {
    const dateString = date.toISOString().split('T')[0];
    return events.filter(event => event.date === dateString);
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}

function openEventModal(date = null) {
    // Vérifier les permissions
    const userRole = '{{ current_user.role }}';
    if (userRole !== 'admin' && userRole !== 'professeur') {
        alert('Seuls les administrateurs et professeurs peuvent créer des événements.');
        return;
    }
    
    const modal = document.getElementById('eventModal');
    if (modal) {
        modal.style.display = 'flex';
        
        if (date) {
            document.getElementById('eventDate').value = date.toISOString().split('T')[0];
        }
    }
}

function closeEventModal() {
    const modal = document.getElementById('eventModal');
    modal.style.display = 'none';
    
    // Reset form
    document.getElementById('eventForm').reset();
}

function saveEvent() {
    // Vérifier les permissions
    const userRole = '{{ current_user.role }}';
    if (userRole !== 'admin' && userRole !== 'professeur') {
        alert('Seuls les administrateurs et professeurs peuvent créer des événements.');
        return;
    }
    
    // Valider les heures
    if (!validateTimes()) {
        return;
    }
    
    const title = document.getElementById('eventTitle').value;
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const type = document.getElementById('eventType').value;
    const description = document.getElementById('eventDescription').value;
    
    if (!title || !date || !startTime || !endTime) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
    }
    
    // Envoyer à l'API
    fetch('/api/events/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            date: date,
            start_time: startTime,
            end_time: endTime,
            type: type,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ajouter l'événement localement
            const newEvent = {
                id: data.event_id,
                title,
                date,
                start_time: startTime,
                end_time: endTime,
                type,
                description
            };
            
            // Recharger les événements depuis le serveur
            loadEvents();
            closeEventModal();
            alert('Événement créé avec succès !');
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la création de l\'événement');
    });
}

function showEventDetails(event) {
    // Vérifier les permissions pour la suppression
    const userRole = '{{ current_user.role }}';
    const canDelete = userRole === 'admin' || userRole === 'professeur';
    
    const timeDisplay = event.start_time ? 
        (event.end_time ? `${event.start_time.substring(0,5)} - ${event.end_time.substring(0,5)}` : event.start_time.substring(0,5)) : 
        'Toute la journée';
    
    // Créer un modal personnalisé pour afficher les détails
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.style.maxWidth = '500px';
    
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.innerHTML = `
        <h3><i class="fas fa-calendar-alt"></i> Détails de l'événement</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
    `;
    
    const body = document.createElement('div');
    body.className = 'modal-body';
    body.innerHTML = `
        <div class="event-details">
            <div class="detail-item">
                <strong><i class="fas fa-tag"></i> Titre:</strong> ${event.title}
            </div>
            <div class="detail-item">
                <strong><i class="fas fa-calendar"></i> Date:</strong> ${new Date(event.date).toLocaleDateString('fr-FR', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })}
            </div>
            <div class="detail-item">
                <strong><i class="fas fa-clock"></i> Heure:</strong> ${timeDisplay}
            </div>
            <div class="detail-item">
                <strong><i class="fas fa-bookmark"></i> Type:</strong> ${event.type}
            </div>
            ${event.description ? `<div class="detail-item"><strong><i class="fas fa-info-circle"></i> Description:</strong> ${event.description}</div>` : ''}
        </div>
    `;
    
    const footer = document.createElement('div');
    footer.className = 'modal-footer';
    
    if (canDelete) {
        footer.innerHTML = `
            <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Fermer</button>
            <button class="btn btn-danger" onclick="confirmDeleteEvent(${event.id}, this.closest('.modal'))">Supprimer</button>
        `;
    } else {
        footer.innerHTML = `
            <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Fermer</button>
        `;
    }
    
    modalContent.appendChild(header);
    modalContent.appendChild(body);
    modalContent.appendChild(footer);
    modal.appendChild(modalContent);
    
    // Fermer en cliquant à l'extérieur
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    document.body.appendChild(modal);
}

// Fonction pour afficher tous les événements d'un jour
function showAllDayEvents(date, events) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';
    modalContent.style.maxWidth = '400px';
    
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.innerHTML = `
        <h3>Événements du ${date.toLocaleDateString('fr-FR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })}</h3>
        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
    `;
    
    const body = document.createElement('div');
    body.className = 'modal-body';
    body.style.maxHeight = '300px';
    body.style.overflowY = 'auto';
    
    events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.style.cssText = `
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid var(--${event.type === 'cours' ? 'primary' : 
                event.type === 'devoir' ? 'secondary' : 
                event.type === 'examen' ? 'danger' : 
                event.type === 'reunion' ? 'accent' : 'gray'});
            background: var(--light);
            cursor: pointer;
            transition: background-color 0.2s ease;
        `;
        
        eventDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">${event.title}</div>
            <div style="font-size: 0.875rem; color: var(--gray);">
                <i class="fas fa-clock"></i> ${event.start_time ? 
                    (event.end_time ? `${event.start_time.substring(0,5)} - ${event.end_time.substring(0,5)}` : event.start_time.substring(0,5)) : 
                    'Toute la journée'}
            </div>
            ${event.description ? `<div style="font-size: 0.875rem; margin-top: 0.5rem;">${event.description}</div>` : ''}
        `;
        
        eventDiv.onmouseover = () => eventDiv.style.backgroundColor = 'var(--gray-light)';
        eventDiv.onmouseout = () => eventDiv.style.backgroundColor = 'var(--light)';
        
        eventDiv.onclick = () => {
            modal.remove();
            showEventDetails(event);
        };
        
        body.appendChild(eventDiv);
    });
    
    const footer = document.createElement('div');
    footer.className = 'modal-footer';
    footer.innerHTML = `
        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Fermer</button>
    `;
    
    modalContent.appendChild(header);
    modalContent.appendChild(body);
    modalContent.appendChild(footer);
    modal.appendChild(modalContent);
    
    // Fermer en cliquant à l'extérieur
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    document.body.appendChild(modal);
}

// Démarrer l'horloge temps réel
function startClock() {
    function updateClock() {
        const now = new Date();
        
        // Formater l'heure
        const timeString = now.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit', 
            second: '2-digit'
        });
        
        // Formater la date
        const dateString = now.toLocaleDateString('fr-FR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Capitaliser la première lettre
        const capitalizedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
        
        // Mettre à jour l'affichage
        const timeElement = document.getElementById('currentTime');
        const dateElement = document.getElementById('currentDate');
        
        if (timeElement) timeElement.textContent = timeString;
        if (dateElement) dateElement.textContent = capitalizedDate;
    }
    
    // Mettre à jour immédiatement puis toutes les secondes
    updateClock();
    clockInterval = setInterval(updateClock, 1000);
}

// Mettre à jour les événements en cours
function updateCurrentEvents() {
    const now = new Date();
    const eventElements = document.querySelectorAll('.event-item');
    
    eventElements.forEach(eventEl => {
        const eventId = eventEl.dataset.eventId;
        const event = events.find(e => e.id == eventId);
        
        if (event && event.start_time && event.end_time) {
            const eventDate = new Date(event.date);
            const startTime = new Date(eventDate.toDateString() + ' ' + event.start_time);
            const endTime = new Date(eventDate.toDateString() + ' ' + event.end_time);
            
            // Vérifier si l'événement est en cours
            if (now >= startTime && now <= endTime) {
                eventEl.classList.add('now');
            } else {
                eventEl.classList.remove('now');
            }
        }
    });
}

// Validation des heures
function validateTimes() {
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    
    if (startTime && endTime) {
        if (startTime >= endTime) {
            alert('L\'heure de fin doit être postérieure à l\'heure de début');
            return false;
        }
    }
    return true;
}

// Charger les événements depuis l'API
function loadEvents() {
    fetch('/api/events')
        .then(response => response.json())
        .then(data => {
            events = data;
            renderCalendar();
            updateCurrentEvents();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des événements:', error);
        });
}

// Confirmer la suppression d'un événement
function confirmDeleteEvent(eventId, modal) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet événement ?')) {
        deleteEventById(eventId, modal);
    }
}

// Supprimer un événement par ID
function deleteEventById(eventId, modal) {
    fetch(`/api/events/${eventId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Supprimer de la liste locale
            events = events.filter(event => event.id !== eventId);
            modal.remove();
            renderCalendar();
            alert('Événement supprimé avec succès !');
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la suppression de l\'événement');
    });
}

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    loadEvents();
    startClock();
    
    // Mettre à jour les événements en cours toutes les minutes
    setInterval(updateCurrentEvents, 60000);
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('eventModal');
    if (event.target === modal) {
        closeEventModal();
    }
}

// Amélioration de la fonction de redimensionnement
function handleResize() {
    if (window.innerWidth <= 768) {
        // Recréer le calendrier avec les paramètres mobile
        renderCalendar();
    }
}

window.addEventListener('resize', handleResize);
</script>
{% endblock %}