{% extends "base.html" %}

{% block title %}Emploi du Temps - Plinify{% endblock %}

{% block content %}
<script>
// Données pour le JavaScript
const scheduleData = {{ schedule|tojson }};
const classroomsData = {{ classrooms|tojson }};
const currentUserIsAdmin = {{ current_user.is_admin()|lower }};
</script>

<div class="card">
    <div class="card-header">
        <h1 class="card-title">
            <i class="fas fa-table"></i>
            Emploi du Temps
        </h1>
        <div class="header-actions">
            <a href="{{ url_for('classrooms') }}" class="btn btn-outline">
                <i class="fas fa-door-open"></i>
                Salles
            </a>
            <button class="btn btn-primary" onclick="exportEDT('pdf')">
                <i class="fas fa-download"></i>
                Exporter
            </button>
        </div>
    </div>

    <div class="edt-navigation">
        <div class="nav-buttons">
            <button id="prevWeek" class="btn btn-outline btn-sm">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="today" class="btn btn-outline btn-sm">
                Aujourd'hui
            </button>
            <button id="nextWeek" class="btn btn-outline btn-sm">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div id="currentWeek" class="current-week">
            Semaine du {{ now.strftime('%d/%m/%Y') }}
        </div>
        <div class="view-actions">
            <button class="btn btn-outline btn-sm" onclick="window.edtManager.exportSchedule('pdf')">
                <i class="fas fa-print"></i>
                Imprimer
            </button>
        </div>
    </div>

    <div class="edt-filters">
        <select class="edt-filter" id="professorFilter">
            <option value="all">Tous les professeurs</option>
            {% for professor in professors %}
            <option value="{{ professor.id }}">{{ professor.prenom }} {{ professor.nom }}</option>
            {% endfor %}
        </select>
        
        <select class="edt-filter" id="classroomFilter">
            <option value="all">Toutes les salles</option>
            {% for classroom in classrooms %}
            <option value="{{ classroom.id }}">{{ classroom.name }}</option>
            {% endfor %}
        </select>
        
        <select class="edt-filter" id="subjectFilter">
            <option value="all">Toutes les matières</option>
            {% for course in courses %}
            <option value="{{ course.name }}">{{ course.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="edt-wrapper">
        <div class="edt-grid" id="edtGrid">
            <!-- Le contenu sera généré par JavaScript -->
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-book"></i>
            Mes Cours
        </h2>
    </div>
    <div class="courses-grid">
        {% for course in courses %}
        <div class="course-card" style="border-left-color: {{ course.color }};">
            <div class="course-header">
                <h3>{{ course.name }}</h3>
                <span class="course-color" style="background: {{ course.color }}"></span>
            </div>
            <div class="course-schedule">
                {% for slot in course.time_slots %}
                <span class="schedule-badge">
                    <i class="fas fa-clock"></i> {{ slot.get_day_name() }} {{ slot.time_range }}
                </span>
                {% endfor %}
            </div>
            <div class="course-info">
                <p><i class="fas fa-user"></i> <strong>Professeur:</strong> {{ course.teacher.prenom }} {{ course.teacher.nom }}</p>
                <p><i class="fas fa-door-open"></i> <strong>Salle:</strong> {{ course.classroom.name }}</p>
                <p><i class="fas fa-tools"></i> <strong>Équipement:</strong> {{ course.classroom.equipment }}</p>
                <p><i class="fas fa-users"></i> <strong>Capacité:</strong> {{ course.classroom.capacity }} places</p>
            </div>
            <div class="course-actions">
                <button class="btn btn-outline btn-sm" onclick="window.edtManager.openCourse({{ course.id }})">
                    <i class="fas fa-info-circle"></i>
                    Détails
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.edt-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: var(--light);
    border-bottom: 1px solid var(--gray-light);
}

.nav-buttons {
    display: flex;
    gap: 0.5rem;
}

.current-week {
    font-weight: 600;
    color: var(--dark);
}

.view-actions {
    display: flex;
    gap: 0.5rem;
}

.edt-filters {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: white;
    border-bottom: 1px solid var(--gray-light);
    flex-wrap: wrap;
}

.edt-filter {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-light);
    border-radius: var(--border-radius);
    background: white;
    font-size: 0.875rem;
    min-width: 150px;
}

.edt-wrapper {
    background: white;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow);
}

.edt-grid {
    display: grid;
    grid-template-columns: 100px repeat(6, 1fr);
    gap: 1px;
    background: var(--gray-light);
}

.edt-time-header {
    background: var(--dark);
    color: white;
    font-weight: 600;
    padding: 1rem 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 0.875rem;
}

.edt-day-header {
    background: var(--primary);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 1rem 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.edt-cell {
    background: white;
    padding: 0.5rem;
    min-height: 100px;
    position: relative;
}

.course-slot {
    border-left: 4px solid;
    padding: 0.5rem;
    border-radius: 8px;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid var(--gray-light);
}

.course-slot:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.course-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--dark);
    line-height: 1.2;
}

.course-details {
    font-size: 0.7rem;
    opacity: 0.8;
    color: var(--dark);
    line-height: 1.2;
}

.course-details div {
    margin-bottom: 0.1rem;
}

.courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.course-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border-left: 4px solid;
    display: flex;
    flex-direction: column;
    height: fit-content;
}

.course-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.course-header h3 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
    color: var(--dark);
    flex: 1;
}

.course-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-left: 1rem;
    flex-shrink: 0;
}

.course-schedule {
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.schedule-badge {
    background: var(--gradient-accent);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.course-info {
    color: var(--gray);
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 1.5rem;
    flex: 1;
}

.course-info p {
    margin: 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.course-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

/* Responsive */
@media (max-width: 1200px) {
    .edt-grid {
        grid-template-columns: 80px repeat(6, 1fr);
        font-size: 0.75rem;
    }
    
    .courses-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .edt-navigation {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .edt-filters {
        flex-direction: column;
    }
    
    .edt-filter {
        min-width: auto;
        width: 100%;
    }
    
    .edt-grid {
        grid-template-columns: 60px repeat(6, 1fr);
        font-size: 0.7rem;
    }
    
    .edt-cell {
        padding: 0.25rem;
        min-height: 80px;
    }
    
    .course-slot {
        padding: 0.3rem;
        font-size: 0.7rem;
    }
    
    .courses-grid {
        grid-template-columns: 1fr;
    }
}

.empty-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray);
    font-size: 0.8rem;
    font-style: italic;
}
</style>

<script src="{{ url_for('static', filename='js/edt.js') }}"></script>
<script>
// Initialisation après le chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('edtGrid')) {
        // L'initialisation se fait automatiquement dans edt.js
        console.log('EDT Manager initialisé');
    }
});
</script>
{% endblock %}